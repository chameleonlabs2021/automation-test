const { Rater } = require('../lib/components/Rater.js');

const global = globalThis;
// To test script - run `node installments.js`
// global.debug = true;
// const payload = JSON.parse('{"operation":"new_business","policy":{"characteristics":[{"createdTimestamp":"1695749143708","endTimestamp":"1727308799999","fieldGroupsByLocator":{"45bd3f2a-6d94-4337-b3ea-a4a84369117e":{"addl_interest_address_city":["Zoeland"],"addl_interest_address_line_1":["499 Delphia Shoal"],"addl_interest_address_line_2":["9294 Cletus Stream"],"addl_interest_address_state":["NY"],"addl_interest_address_zip":["10004"],"addl_interest_email":["Gage.Weissnat@hotmail.com"],"addl_interest_name":["Brady"]},"5cd737f3-112b-4841-8c7f-f0647ac0f247":{"non_primary_custom_member_id":["AA7044"],"non_primary_dob":["2000-01-01"],"non_primary_email":["Loren.Hills@yahoo.com"],"non_primary_name":["Miranda Willms"],"non_primary_phone":["999-704-7817"],"non_primary_relationship":["spouse_named_insured"]},"906e37f9-7fe4-4bce-872d-01fe00052f19":{"address_city":["Mattieland"],"address_county":["New York County"],"address_line_1":["0509 Verda Orchard"],"address_line_2":["036 Otho Fall"],"address_state":["NY"],"address_zip":["10004"],"building_id":["u"],"iso_protection_class":["7"],"iso_territory_code":["5"],"sfdc_property_id_at_purchase":["6"]}},"fieldValues":{"addl_interests":["45bd3f2a-6d94-4337-b3ea-a4a84369117e"],"all_peril_deductible":["250"],"auto_renewal_status":["renew"],"building_code_effectiveness_grade":["5"],"building_details":["906e37f9-7fe4-4bce-872d-01fe00052f19"],"construction_type":["frame"],"custom_policy_number":["AA7044"],"has_restricted_dog_breed":["no"],"items_to_schedule":["yes"],"non_primary_policy_holders":["5cd737f3-112b-4841-8c7f-f0647ac0f247"],"number_of_units_in_building":["two units"],"number_significant_others":["1"],"policy_term":["1"],"prior_claims":["0"],"protective_devices":["na"],"rater_id":["AA7044"],"rater_source":["AA7044"],"superior_construction":["no"]},"locator":"cca96c74-27a5-419e-baef-24c60233c7d9","mediaByLocator":{},"policyEndTimestamp":"1727308799999","policyLocator":"100500652","policyStartTimestamp":"1695686400000","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","startTimestamp":"1695686400000","taxGroups":[],"updatedTimestamp":"1695749143708"}],"configVersion":"255","createdTimestamp":"1695749143708","currency":"USD","displayId":"100500652","documents":[],"effectiveContractEndTimestamp":"1727308799999","exposures":[{"characteristics":[{"createdTimestamp":"1695749143708","endTimestamp":"1727308799999","exposureLocator":"12fc096a-8f6f-486c-9e63-d49e091acccb","fieldGroupsByLocator":{},"fieldValues":{},"locator":"4954ab65-3a67-4c64-838e-487763f119e7","mediaByLocator":{},"policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","startTimestamp":"1695686400000","updatedTimestamp":"1695749143708"}],"createdTimestamp":"1695749143708","displayId":"100500658","locator":"12fc096a-8f6f-486c-9e63-d49e091acccb","name":"property","perils":[{"characteristics":[{"coverageEndTimestamp":"1727308799999","coverageStartTimestamp":"1695686400000","createdTimestamp":"1695749143708","deductible":"200.00","exposureCharacteristicsLocator":"4954ab65-3a67-4c64-838e-487763f119e7","fieldGroupsByLocator":{},"fieldValues":{},"locator":"990c2e63-d63c-464e-817c-8eb6f34eac73","mediaByLocator":{},"perilLocator":"f9d6d58c-0cfa-47db-9b2c-e890e68fc117","policyCharacteristicsLocator":"cca96c74-27a5-419e-baef-24c60233c7d9","policyLocator":"100500652","policyModificationLocator":"330e4942-bdbd-4b16-bf59-8efdce3fba1a","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","updatedTimestamp":"1695749143708"}],"createdTimestamp":"1695749143708","displayId":"100500660","exposureLocator":"12fc096a-8f6f-486c-9e63-d49e091acccb","locator":"f9d6d58c-0cfa-47db-9b2c-e890e68fc117","name":"coverage_c_contents","policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","renewalGroup":"f9d6d58c-0cfa-47db-9b2c-e890e68fc117","updatedTimestamp":"1695749143708"},{"characteristics":[{"coverageEndTimestamp":"1727308799999","coverageStartTimestamp":"1695686400000","createdTimestamp":"1695749143708","deductible":"500.00","exposureCharacteristicsLocator":"4954ab65-3a67-4c64-838e-487763f119e7","fieldGroupsByLocator":{},"fieldValues":{},"locator":"3761c6b1-0455-4f81-8c76-f7f9e7942375","mediaByLocator":{},"perilLocator":"d9971fa3-72ee-400b-8e90-614531d17298","policyCharacteristicsLocator":"cca96c74-27a5-419e-baef-24c60233c7d9","policyLocator":"100500652","policyModificationLocator":"330e4942-bdbd-4b16-bf59-8efdce3fba1a","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","updatedTimestamp":"1695749143708"}],"createdTimestamp":"1695749143708","displayId":"100500662","exposureLocator":"12fc096a-8f6f-486c-9e63-d49e091acccb","locator":"d9971fa3-72ee-400b-8e90-614531d17298","name":"coverage_d_loss_of_use","policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","renewalGroup":"d9971fa3-72ee-400b-8e90-614531d17298","updatedTimestamp":"1695749143708"}],"policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","updatedTimestamp":"1695749143708"}],"fees":[],"grossFees":"0.00","invoices":[],"locator":"100500652","modifications":[{"configVersion":"252","createdTimestamp":"1695749143708","displayId":"100500656","effectiveTimestamp":"1695686400000","exposureModifications":[{"exposureLocator":"12fc096a-8f6f-486c-9e63-d49e091acccb","locator":"6ea76b29-e724-41d6-a42c-123cecddc1af","newExposureCharacteristicsLocator":"4954ab65-3a67-4c64-838e-487763f119e7","perilModifications":[{"exposureModificationLocator":"6ea76b29-e724-41d6-a42c-123cecddc1af","locator":"aad4c522-74ff-4e48-968a-2e6e505852d6","newPerilCharacteristicsLocator":"990c2e63-d63c-464e-817c-8eb6f34eac73","perilLocator":"f9d6d58c-0cfa-47db-9b2c-e890e68fc117","policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770"},{"exposureModificationLocator":"6ea76b29-e724-41d6-a42c-123cecddc1af","locator":"738e74ea-9b49-4e16-a05e-9fba93b521fb","newPerilCharacteristicsLocator":"3761c6b1-0455-4f81-8c76-f7f9e7942375","perilLocator":"d9971fa3-72ee-400b-8e90-614531d17298","policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770"}],"policyLocator":"100500652","policyModificationLocator":"330e4942-bdbd-4b16-bf59-8efdce3fba1a","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770"}],"fieldGroupsByLocator":{},"fieldValues":{},"locator":"330e4942-bdbd-4b16-bf59-8efdce3fba1a","mediaByLocator":{},"name":"modification.policy.create","newPolicyCharacteristicsLocator":"cca96c74-27a5-419e-baef-24c60233c7d9","newPolicyCharacteristicsLocators":["cca96c74-27a5-419e-baef-24c60233c7d9"],"number":"0","policyLocator":"100500652","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","updatedTimestamp":"1695749143708"}],"originalContractEndTimestamp":"1727308799999","originalContractStartTimestamp":"1695686400000","paymentScheduleName":"annually","policyholderLocator":"d1369049-6303-4d41-8cc0-04e46c00b20b","productLocator":"11ee-0a2c-1c92de50-8b7b-138e66f7b770","productName":"Protect","quoteSummary":{"notDiscarded":[{"locator":"100500664","name":"1","state":"draft"}],"selected":"100500664"},"updatedTimestamp":"1695749143708"},"policyExposurePerils":[{"exposureCharacteristicsLocator":"4954ab65-3a67-4c64-838e-487763f119e7","perilCharacteristicsLocator":"990c2e63-d63c-464e-817c-8eb6f34eac73","policyCharacteristicsLocator":"cca96c74-27a5-419e-baef-24c60233c7d9"},{"exposureCharacteristicsLocator":"4954ab65-3a67-4c64-838e-487763f119e7","perilCharacteristicsLocator":"3761c6b1-0455-4f81-8c76-f7f9e7942375","policyCharacteristicsLocator":"cca96c74-27a5-419e-baef-24c60233c7d9"}],"quoteLocator":"100500664","tenantTimeZone":"UTC"}');
// console.log(JSON.stringify(getPerilRates(payload)));

function getPerilRates(data) {
    console.log(`Rater Plugin - ${data?.policy?.locator}`);
    console.log(JSON.stringify(data));

    // Read test indicator from Aux Data
    let testIndicator;
    if (!global?.debug) {
        testIndicator = socotraApi.getAuxData(data?.policy?.locator, 'test-indicator');
        console.log('Test indicator: ', testIndicator);
    } else {
        // testIndicator = 'hourly';
    }

    const options = {
        ...(testIndicator ? {
        } : {}),
        ...(global.debug ? {
            perilRates: JSON.stringify({
                'coverage_c_contents': 500,
                'coverage_d_loss_of_use': 250,
            }),
        } : {}),
    }

    const response = new Rater(data, options).getRatedAmounts();
    console.log('Rater Response: ', JSON.stringify(response));
    return response;
}

module.exports = { getPerilRates };